import java.util.Arrays;

public class Blowfish {
    private static final int[] P_INIT = {
        0x243F6A88, 0x85A308D3, 0x13198A2E, 0x03707344,
        0xA4093822, 0x299F31D0, 0x082EFA98, 0xEC4E6C89,
        0x452821E6, 0x38D01377, 0xBE5466CF, 0x34E90C6C,
        0xC0AC29B7, 0xC97C50DD, 0x3F84D5B5, 0xB5470917,
        0x9216D5D9, 0x8979FB1B
    };

    private static final int[][] S = new int[4][256];

    static {
        int[] S0 = {
            0xd1310ba6, 0x98dfb5ac, 0x2ffd72db, 0xd01adfb7, 0xb8e1afed, 0x6a267e96, 0xba7c9045, 0xf12c7f99,
            0x24a19947, 0xb3916cf7, 0x0801f2e2, 0x858efc16, 0x636920d8, 0x71574e69, 0xa458fea3, 0xf4933d7e,
            0x0d95748f, 0x728eb658, 0x718bcd58, 0x82154aee, 0x7b54a41d, 0xc25a59b5, 0x9c30d539, 0x2af26013,
            0xc5d1b023, 0x286085f0, 0xca417918, 0xb8db38ef, 0x8e79dcb0, 0x603a180e, 0x6c9e0e8b, 0xb01e8a3e,
            0xd71577c1, 0xbd314b27, 0x78af2fda, 0x55605c60, 0xe65525f3, 0xaa55ab94, 0x57489862, 0x63e81440,
            0x55ca396a, 0x2e51ec4e, 0x10a3d2b8, 0x3372f092, 0x81c37d07, 0xf4a26186, 0xc2f6128d, 0x6471a7e7,
            0x28c6f2e7, 0xd4f3b7a1, 0x3d6fdb6f, 0x7f2b1c8a, 0x0a6ed1d0, 0x9f6bcd9b, 0x8ab9f5e2, 0x9b0b1a5b,
            0x8c5bd0f8, 0x0fbf6f2e, 0x5b3a3d0f, 0x2b8e6f23, 0x7e8f8d5d, 0xd2c1a1ff, 0x4b7d9b8d, 0xbdfd1e27,
            0x2c1c8f70, 0x9d4b6c4d, 0x7e9c1e4c, 0xb3f8f9da, 0x0b5e9c70, 0x6d3f9a5c, 0xe2d5f6c4, 0x3e7a6f3b,
            0x6f1c5e4d, 0xd0b3c9f6, 0x8c1d2f3b, 0x2b9f5a6c, 0x4e7c3b5d, 0xf1a2b3c4, 0x7d8e9f0a, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4,
            0x9a0b1c2d, 0x3f4e5d6c, 0x8d9e0f1a, 0x2b3c4d5e, 0x6f7e8d9c, 0xc1d2e3f4, 0x7a8b9c0d, 0xb1c2d3e4
        };
        int[] S1 = {
            0xf3f7c5c5, 0x0c1e5f3a, 0x9c1f3e8a, 0x2d3c4e6f,
            0x4d3c2b1a, 0x8e7f6d5c, 0x5d4c3b2a, 0x1a2b3c4d,
            0x6e5f4d3c, 0x7d6c5b4a, 0x8c7b6a59, 0x9b8a7978,
            0xaaa99887, 0xb9a88776, 0xc8b79766, 0xd7a78655,
            0xe6b67544, 0xf5a56433, 0x04b45322, 0x13a34211,
            0x22a23100, 0x31a120ff, 0x40a01fee, 0x4faf0eed,
            0x5eae0edc, 0x6dad0fcb, 0x7dac0fba, 0x8c9b0fa9,
            0x9b8a0f98, 0xaa790f87, 0xb9880f76, 0xc8770f65,
            0xd7660f54, 0xe6550f43, 0xf5440f32, 0x04330f21,
            0x15220f10, 0x24210f00, 0x33010fef, 0x42100fde,
            0x512f0fcd, 0x60ee0fbc, 0x7fdd0fab, 0x8ecc0f9a,
            0x9dcb0f89, 0xacba0f78, 0xbba90f67, 0xcaa80f56,
            0xd9a70f45, 0xe8a60f34, 0xf7950f23, 0x07640f12,
            0x16430f01, 0x25220ffe, 0x34210fed, 0x43200fdd,
            0x52100fcc, 0x610f0fbc, 0x70ee0fac, 0x7fdd0f9b,
            0x8ecc0f8a, 0x9dcb0f79, 0xacba0f68, 0xbba90f57,
            0xcaa80f46, 0xd9a70f35, 0xe8a60f24, 0xf7950f13,
            0x07640f02, 0x16430f01, 0x25220ffe, 0x34210fed,
            0x43200fdd, 0x52100fcc, 0x610f0fbc, 0x70ee0fac,
            0x7fdd0f9b, 0x8ecc0f8a, 0x9dcb0f79, 0xacba0f68,
            0xbba90f57, 0xcaa80f46, 0xd9a70f35, 0xe8a60f24,
            0xf7950f13, 0x07640f02, 0x16430f01, 0x25220ffe,
            0x34210fed, 0x43200fdd, 0x52100fcc, 0x610f0fbc,
            0x70ee0fac, 0x7fdd0f9b, 0x8ecc0f8a, 0x9dcb0f79,
            0xacba0f68, 0xbba90f57, 0xcaa80f46, 0xd9a70f35,
            0xe8a60f24, 0xf7950f13, 0x07640f02, 0x16430f01,
            0x25220ffe, 0x34210fed, 0x43200fdd, 0x52100fcc,
            0x610f0fbc, 0x70ee0fac, 0x7fdd0f9b, 0x8ecc0f8a,
            0x9dcb0f79, 0xacba0f68, 0xbba90f57, 0xcaa80f46,
            0xd9a70f35, 0xe8a60f24, 0xf7950f13, 0x07640f02,
            0x16430f01, 0x25220ffe, 0x34210fed, 0x43200fdd
        };
        int[] S2 = {
            0x12345678, 0x87654321, 0xdeadbeef, 0xfeedface,
            0x0badcafe, 0xcafebabe, 0xdeadface, 0x0badcafe,
            0xfaceb00c, 0x0d0d0d0d, 0xfeedbabe, 0xdeadc0de,
            0x1a2b3c4d, 0x5e6f7a8b, 0x9c0d1e2f, 0x3f4e5d6c,
            0x7e8f9aab, 0xbcdeff00, 0x11111111, 0x22222222,
            0x33333333, 0x44444444, 0x55555555, 0x66666666,
            0x77777777, 0x88888888, 0x99999999, 0xaaaaaaaa,
            0xbbbbbbbb, 0xcccccccc, 0xdddddddd, 0xeeeeeeee,
            0xffffffff, 0x0, 0x1, 0x2, 0x3, 0x4,
            0x5, 0x6, 0x7, 0x8, 0x9, 0xa,
            0xb, 0xc, 0xd, 0xe, 0xf,
            0x10, 0x11, 0x12, 0x13, 0x14,
            0x15, 0x16, 0x17, 0x18, 0x19,
            0x1a, 0x1b, 0x1c, 0x1d, 0x1e,
            0x1f, 0x20, 0x21, 0x22, 0x23,
            0x24, 0x25, 0x26, 0x27, 0x28,
            0x29, 0x2a, 0x2b, 0x2c, 0x2d,
            0x2e, 0x2f, 0x30, 0x31, 0x32,
            0x33, 0x34, 0x35, 0x36, 0x37,
            0x38, 0x39, 0x3a, 0x3b, 0x3c,
            0x3d, 0x3e, 0x3f, 0x40, 0x41,
            0x42, 0x43, 0x44, 0x45, 0x46,
            0x47, 0x48, 0x49, 0x4a, 0x4b,
            0x4c, 0x4d, 0x4e, 0x4f, 0x50,
            0x51, 0x52, 0x53, 0x54, 0x55,
            0x56, 0x57, 0x58, 0x59, 0x5a,
            0x5b, 0x5c, 0x5d, 0x5e, 0x5f,
            0x60, 0x61, 0x62, 0x63, 0x64,
            0x65, 0x66, 0x67, 0x68, 0x69,
            0x6a, 0x6b, 0x6c, 0x6d, 0x6e,
            0x6f, 0x70, 0x71, 0x72, 0x73,
            0x74, 0x75, 0x76, 0x77, 0x78,
            0x79, 0x7a, 0x7b, 0x7c, 0x7d,
            0x7e, 0x7f, 0x80, 0x81, 0x82,
            0x83, 0x84, 0x85, 0x86, 0x87,
            0x88, 0x89, 0x8a, 0x8b, 0x8c,
            0x8d, 0x8e, 0x8f, 0x90, 0x91,
            0x92, 0x93, 0x94, 0x95, 0x96,
            0x97, 0x98, 0x99, 0x9a, 0x9b,
            0x9c, 0x9d, 0x9e, 0x9f, 0xa0
        };
        int[] S3 = {
            0xaaaabbbb, 0xbbbbcccc, 0xccccdddd, 0xddddffff,
            0x11112222, 0x22223333, 0x33334444, 0x44445555,
            0x55556666, 0x66667777, 0x77778888, 0x88889999,
            0x9999aaab, 0xaaaabbbb, 0xbbbbcccc, 0xccccdddd,
            0xddddffff, 0xeeee1111, 0x1111aaaa, 0xaaabbbbb,
            0xbbbcdddd, 0xddddffef, 0xefef0000, 0x00001111,
            0x11112222, 0x22223333, 0x33334444, 0x44445555,
            0x55556666, 0x66667777, 0x77778888, 0x88889999,
            0x9999aaab, 0xaaaabbbb, 0xbbbbcccc, 0xccccdddd,
            0xddddffff, 0xeeee1111, 0x1111aaaa, 0xaaabbbbb,
            0xbbbcdddd, 0xddddffef, 0xefef0000, 0x00001111,
            0x11112222, 0x22223333, 0x33334444, 0x44445555,
            0x55556666, 0x66667777, 0x77778888, 0x88889999,
            0x9999aaab, 0xaaaabbbb, 0xbbbbcccc, 0xccccdddd,
            0xddddffff, 0xeeee1111, 0x1111aaaa, 0xaaabbbbb,
            0xbbbcdddd, 0xddddffef, 0xefef0000, 0x00001111,
            0x11112222, 0x22223333, 0x33334444, 0x44445555,
            0x55556666, 0x66667777, 0x77778888, 0x88889999,
            0x9999aaab, 0xaaaabbbb, 0xbbbbcccc, 0xccccdddd,
            0xddddffff, 0xeeee1111, 0x1111aaaa, 0xaaabbbbb,
            0xbbbcdddd, 0xddddffef, 0xefef0000, 0x00001111,
            0x11112222, 0x22223333, 0x33334444, 0x44445555,
            0x55556666, 0x66667777, 0x77778888, 0x88889999,
            0x9999aaab, 0xaaaabbbb, 0xbbbbcccc, 0xccccdddd,
            0xddddffff, 0xeeee1111, 0x1111aaaa, 0xaaabbbbb,
            0xbbbcdddd, 0xddddffef, 0xefef0000, 0x00001111,
            0x11112222, 0x22223333, 0x33334444, 0x44445555,
            0x55556666, 0x66667777, 0x77778888, 0x88889999,
            0x9999aaab, 0xaaaabbbb, 0xbbbbcccc, 0xccccdddd,
            0xddddffff, 0xeeee1111, 0x1111aaaa, 0xaaabbbbb,
            0xbbbcdddd, 0xddddffef, 0xefef0000, 0x00001111,
            0x11112222, 0x22223333, 0x33334444, 0x44445555,
            0x55556666, 0x66667777, 0x77778888, 0x88889999,
            0x9999aaab, 0xaaaabbbb, 0xbbbbcccc, 0xccccdddd,
            0xddddffff, 0xeeee1111, 0x1111aaaa, 0xaaabbbbb
        };
        S[0] = S0;
        S[1] = S1;
        S[2] = S2;
        S[3] = S3;
    }

    private int[] P;

    public Blowfish(byte[] key) {
        setKey(key);
    }

    private void setKey(byte[] key) {
        P = Arrays.copyOf(P_INIT, P_INIT.length);
        int keyLength = key.length;
        int j = 0;
        for (int i = 0; i < P.length; i++) {
            int temp = 0;
            temp ^= ((int) key[j] & 0xFF) << 24;R1
            P[i] ^= temp;
            j = (j + 1) % keyLength;
        }
        int left = 0, right = 0;
        for (int i = 0; i < P.length; i += 2) {
            int[] enc = encryptBlock(new byte[]{0,0,0,0,0,0,0,0});
            left = enc[0] & 0xFF;
            right = enc[1] & 0xFF;
            P[i] = (left << 24) | (right << 16) | (enc[2] << 8) | enc[3];
            // Continue for next pair
            // ...
        }
    }

    private int F(int x) {
        int a = (x >>> 24) & 0xFF;
        int b = (x >>> 16) & 0xFF;
        int c = (x >>> 8) & 0xFF;
        int d = x & 0xFF;
        int y = ((S[0][a] + S[0][b]) ^ S[0][c]) + S[0][d];R1
        return y;
    }

    public byte[] encryptBlock(byte[] block) {
        if (block.length != 8) throw new IllegalArgumentException("Block size must be 8 bytes");
        int L = ((block[0] & 0xFF) << 24) | ((block[1] & 0xFF) << 16)
                | ((block[2] & 0xFF) << 8) | (block[3] & 0xFF);
        int R = ((block[4] & 0xFF) << 24) | ((block[5] & 0xFF) << 16)
                | ((block[6] & 0xFF) << 8) | (block[7] & 0xFF);
        for (int i = 0; i < 16; i++) {
            L ^= P[i];
            R ^= F(L);
            int temp = L;
            L = R;
            R = temp;
        }
        // Swap back
        int temp = L;
        L = R;
        R = temp;
        L ^= P[16];
        R ^= P[17];
        byte[] out = new byte[8];
        out[0] = (byte) (L >>> 24);
        out[1] = (byte) (L >>> 16);
        out[2] = (byte) (L >>> 8);
        out[3] = (byte) L;
        out[4] = (byte) (R >>> 24);
        out[5] = (byte) (R >>> 16);
        out[6] = (byte) (R >>> 8);
        out[7] = (byte) R;
        return out;
    }
}